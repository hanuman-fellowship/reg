#!/usr/bin/env perl
use strict;
use warnings;
use CGI;
my $q = CGI->new();
use CGI::Carp qw/fatalsToBrowser/;
use lib '.', '../lib';
use Template;

#
# gather all the form elements into a hash
#
my %form = $q->Vars();
for my $w (keys %form) {
    $form{$w} =~ s{^\s*|\s*$}{}g;       # trim the fields
}
# form defaults
#
if ($form{country} !~ /\S/) {
    $form{country} = "USA";     # default
}

my %cookie = %form;
my $cookie = $q->cookie(
    -name    => 'user_data',
    -value   => \%cookie,
    -expires => '+10y',     # i.e. don't expire
    -domain  => 'www.mountmadonna.org',
);
print $q->header(-cookie => $cookie);

#
# prepare the confirmation page.
#

my $x_amount = $form{amount}; 

my %stash;
for my $name (qw/
    rec_fname rec_lname rec_email
    fname lname street1 street2 city state zip
    country cell email1 personal_note
/) {
    $stash{$name} = $form{$name};
}
if ($form{personal_note}) {
    my $s = $form{personal_note};
    $s =~ s{\n}{<br>}xmsg;
    $stash{personal_note_verbose} = $s;
}

#
# create a readable description for the user
#
$stash{phone} = $form{cell};    # used to have home work cell... 

#
# in addition to the street1, street2 above
# which are for the hidden fields we also have
# street_addr which is a special case.
#
my $street_addr = $form{street1};
if ($form{street2} =~ /\S/) {
    $street_addr .= "<br>$form{street2}";
}
$stash{street_addr} = $street_addr;

# ip address for Jamal's purposes
#
$stash{real_ip} = $ENV{REMOTE_ADDR};

Template->new(
    INTERPOLATE => 1,
)->process(
    'gift_card2.tt2',
    \%stash,
);
