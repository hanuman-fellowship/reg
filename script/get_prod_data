ssh-keyscan ec2-13-57-186-109.us-west-1.compute.amazonaws.com> ~/.ssh/known_hosts

ssh sahadev@ec2-13-57-186-109.us-west-1.compute.amazonaws.com \
    "ls -1tr /var/reg_backup/grid.* | tail -1" \
    | xargs -iz -I '{}' \
    scp sahadev@ec2-13-57-186-109.us-west-1.compute.amazonaws.com:{} .

sudo tar zxvf grid.* -C /var/Reg/grid
sudo chown vagrant:www-data /var/Reg/grid/*

ssh sahadev@ec2-13-57-186-109.us-west-1.compute.amazonaws.com \
    "ls -1tr /var/reg_backup/rc.* | tail -1" \
    | xargs -iz -I '{}' \
    scp sahadev@ec2-13-57-186-109.us-west-1.compute.amazonaws.com:{} .

pv rc.* | gunzip | mysql

rm rc.* grid.*

mysql <<EOS
-- new mechanism for session data
DROP TABLE IF EXISTS sessions;
CREATE TABLE sessions (
    id           CHAR(72) PRIMARY KEY,
    session_data TEXT,
    expires      INTEGER
);

-- all email comes to us
UPDATE string
   SET   value = 'jon@suecenter.org, jjn1056@gmail.com'
 WHERE the_key = 'redirect_email';

-- talk to the clone of mountmadonna.org
UPDATE string
   SET   value = 'mmc.jasongaluten.com'
 WHERE the_key = 'ftp_site';

-- remove any reference to rides and drivers
DROP TABLE IF EXISTS ride;
DELETE FROM role where role = 'ride_admin';
DELETE FROM role where role = 'driver';
DELETE FROM user_role where role_id in (12, 13);

DELETE FROM string where the_key like '%ride%';
DELETE FROM string where the_key = 'max_shuttles' OR the_key = 'ftp_userpics';
DELETE FROM string where the_key like 'MRY%';
DELETE FROM string where the_key like 'OAK%';
DELETE FROM string where the_key like 'OTH%';
DELETE FROM string where the_key like 'SFO%';
DELETE FROM string where the_key like 'SJC%';
DELETE FROM string where the_key like '%imgwidth';

DROP TABLE IF EXISTS program_doc;

-- comment these out once the production db has dropped the columns
-- no images for leaders
ALTER TABLE leader DROP COLUMN image;
-- no images for programs
ALTER TABLE program DROP COLUMN image;
-- no images for residents
ALTER TABLE resident DROP COLUMN image;
-- no documents for programs

EOS
