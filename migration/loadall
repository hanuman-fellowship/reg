#!/bin/sh
howmuch='f07'       # f89

if [ `whoami` = 'sahadev' ]
then
    db='mysql -u sahadev -pJonB reg2'
    export DBI_DSN="dbi:mysql:reg2"
    perl -p -i -e 's/autoincrement/auto_increment/' mk*
    MYSQL=1
else
    db='sqlite3 retreatcenter.db'
    export DBI_DSN="dbi:SQLite:retreatcenter.db"
    MYSQL=
fi

echo creating tables
echo people; $db <mkpeople
echo misc  ; $db <mkmisc
echo prog  ; $db <mkprog
echo rent  ; $db <mkrent
echo rep   ; $db <mkrep
echo users ; $db <mkusers
echo member ; $db <mkmember
echo reg   ; $db <mkreg
echo event ; $db <mkevent
echo acct  ; $db <mkacct
echo meet  ; $db <mkmeet
echo house ; $db <mkhouse

echo strings
loadstr
echo affils
loadaf

echo clearing images
cd ../root/static/images
rm -f 20*.png lo* lth* lb* po* pth* pb*
cd ../../../migration

echo people
loadpeople
echo leaders, canpol, housecost, programs
loadprog $howmuch
echo registrations
loadreg $howmuch
echo rentals
loadrent $howmuch

# load all mmi payments
loadmmi

# add a LOT of config records
loadconfig $MYSQL

# now we can load future housing
echo housing assignments
loadhousing

# conf notes
loadnote

# initialize the member and donation data
echo Donations
loaddon
echo Memberships
loadmem

# split the F08 PRs from the S08 ones
# this is done before the regcount is done...
echo split F08 PRs from S08
splitPR

# update the reg_count field in all program records
echo updating regcount
regcount

if [ `whoami` = 'jonbjornstad' ]
then
    cp retreatcenter.db ..
fi
